<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="/css/ku_list.css">
    <title>KUí•´ íŒ€êµ¬í•˜ê¸°</title>
</head>

<body>
    <%-include('top_bar.ejs')%>

    <header>
        <h1>ì—¬ê¸°ì„œ íŒ€ KUí•´</h1>
    </header>

    <div class="search-container">
        <select id="category" name="category">
            <option value="ì „ì²´">ì „ì²´</option>
            <option value="ê³µëª¨ì „">ê³µëª¨ì „</option>
            <option value="ìŠ¤í„°ë””">ìŠ¤í„°ë”” ëª¨ì„</option>
            <option value="ì¡°ë³„ê³¼ì œ">ì¡°ë³„ê³¼ì œ</option>
            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
          </select>
        <button class="search-button" onclick="searchList()">ê²€ìƒ‰</button>
    </div>

    <section>
        
        <% lists.forEach((item, index) => { %>
            <div class="team-card">
                <div id="reported-count">ì‹ ê³  ìˆ˜: <%= item.report %></div>
                <h2><%= item.title %></h3>
                <div class="team-info2">
                    <h4>[<%= item.is_Online %>] [<%= item.category %>]</h4>
                </div>
               
                <h4><%= item.content %></h4>
                <button onclick="matching('<%= item.author %>', '<%= item.title %>')" class="matching">ë§¤ì¹­í•˜ê¸°</button>
                <button onclick="upPassion('<%= item.author %>')" class="heart-icon">&#10084;</button>
                <button onclick="reportList(<%= item.id %>)" class="report-button">ğŸš¨</button>
            
            <% if ( typeof user !== 'undefined') { %>
                <% if ( user.user_id  ===  item.author || user.is_superuser === 1 ){ %>
                    <div class="team-buttons">
                        <button onclick="editList(<%= item.id %>)" class="edit-button">ìˆ˜ì •</button>
                        <button onclick="deleteList(<%= item.id %>)" class="delete-button">ì‚­ì œ</button>
                    </div>
                <% } %>
            <% } %>

                <div class="team-info">
                    <h5>ì‘ì„±ì: <%= item.author %></h5>
                    <% const createDate = new Date(item.create_date); %>
                    <% const formattedDate = `${createDate.getFullYear()}. ${createDate.getMonth() + 1}. ${createDate.getDate()}`; %>
                    <h5><%= formattedDate %></h5>
                </div>
            </div>
        <% }); %>
    </section>

    <% if ( typeof user !== 'undefined') { %>
        <div class="button-container">
            <button class="write-button" onclick="location.href='/ku_list/add'">ê¸€ì“°ê¸°</button>
        </div>
    <% } %>

    <div class="pagination">
        <% for (let i = 1; i <= totalPages; i++) { %>
            <a href="#" onclick="changePage(<%= i %>)"><%= i %></a>
        <% } %>
    </div>

    <script>
        // ê²€ìƒ‰
        function searchList() {
            const category = document.getElementById('category').value;
            if(category === 'ì „ì²´'){
                window.location.href='/ku_list';
                return;
            }
            window.location.href=`/ku_list?category=${category}`;
        }

        // í˜ì´ì§€ ë³€ê²½
        function changePage(pageNumber) {
            const category = '<%= category %>';
            
            if(category === 'ì „ì²´'){
                window.location.href=`/ku_list?page=${pageNumber}`;
                return;
            }
            window.location.href = `/ku_list?page=${pageNumber}&category=${encodeURIComponent(category)}`;
        }

        // ë§¤ì¹­í•˜ê¸°
        function matching(receiver, title) {
            '<% if( typeof user !== "undefined") { %>'
                const sender = '<%= user.user_id %>';
                
                const xhr = new XMLHttpRequest();
                
                xhr.open('POST', '/chat/createrequest', true);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

                xhr.onreadystatechange = function() {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        if (xhr.status === 200) {
                            const response = JSON.parse(xhr.responseText);
                            // ì±„íŒ… ìš”ì²­ ê²°ê³¼ í‘œì‹œ
                            alert(response.message);
                        } else {
                            console.error('Error: ' + xhr.status);
                        }
                    }
                };
                
                xhr.send('sender=' + encodeURIComponent(sender) + 
                        '&receiver=' + encodeURIComponent(receiver) +
                        '&title=' + encodeURIComponent(title));
            '<% } else { %>'
                alert('ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.');
                return;
            '<% } %>'
        }

        // ìˆ˜ì • ë²„íŠ¼
        function editList(listId){
            window.location.href = `/ku_list/edit?listId=${listId}`;
        }

        // ì‚­ì œ ë²„íŠ¼
        function deleteList(listId) {
            const xhr = new XMLHttpRequest();
            
            xhr.open('POST', '/ku_list/delete', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    
            xhr.onreadystatechange = function() {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        // ê²°ê³¼ í‘œì‹œ
                        alert(response.message);
                        window.location.reload();
                    } else {
                        console.error('Error: ' + xhr.status);
                    }
                }
            };
            
            xhr.send('listId=' + encodeURIComponent(listId));
        }

        // ì—´ì •ë„ ì¦ê°€
        function upPassion(receiver) {
            '<% if( typeof user !== "undefined") { %>'
                const sender = '<%= user.user_id %>';

                const xhr = new XMLHttpRequest();
            
                xhr.open('POST', '/my_page/uppassion', true);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        if (xhr.status === 200) {
                            const response = JSON.parse(xhr.responseText);
                            // ê²°ê³¼ í‘œì‹œ
                            alert(response.message);
                            window.location.reload();
                        } else {
                            console.error('Error: ' + xhr.status);
                        }
                    }
                };
                
                xhr.send('sender=' + encodeURIComponent(sender) + 
                            '&receiver=' + encodeURIComponent(receiver));
            '<% } else { %>'
                    alert('ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.');
                    return;
            '<% } %>'
        }

        // ì‹ ê³ í•˜ê¸°
        function reportList(postId) {
            '<% if( typeof user !== "undefined") { %>'
                const userId = '<%= user.user_id %>';
                const xhr = new XMLHttpRequest();
            
                xhr.open('POST', '/ku_list/report', true);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        if (xhr.status === 200) {
                            const response = JSON.parse(xhr.responseText);
                            // ì‹ ê³  ê²°ê³¼ í‘œì‹œ
                            alert(response.message);
                            window.location.reload();
                        } else {
                            console.error('Error: ' + xhr.status);
                        }
                    }
                };
                
                xhr.send('postId=' + encodeURIComponent(postId) + 
                            '&userId=' + encodeURIComponent(userId));                
            '<% } else { %>'
                    alert('ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.');
                    return;
            '<% } %>'
        }
    </script>

</body>

</html>
